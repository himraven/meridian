server {
    listen 80;
    server_name meridianfin.io www.meridianfin.io localhost;

    # ── API: Signal & market data (cacheable, T+1 delay) ────────────
    # Data updates at most every few minutes via crons.
    # Cloudflare-CDN-Cache-Control: tells CF edge to cache (stripped before browser).
    # Cache-Control: tells browser to cache.
    location ~ ^/api/(signals|us|cn|hk|dividend) {
        proxy_pass http://api:8502;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Strip upstream Cache-Control (we control it here)
        proxy_hide_header Cache-Control;
        proxy_hide_header CDN-Cache-Control;
        proxy_hide_header Cloudflare-CDN-Cache-Control;

        # Browser: 5 min cache + 1 min stale-while-revalidate
        add_header Cache-Control "public, max-age=300, stale-while-revalidate=60" always;
        # CF edge: 10 min cache + 30 min stale tolerance (stripped by CF before reaching browser)
        add_header Cloudflare-CDN-Cache-Control "public, max-age=600, stale-while-revalidate=1800" always;
        add_header Vary "Accept-Encoding" always;
    }

    # ── API: Ticker detail (per-stock, high cardinality but stable) ──
    location /api/ticker/ {
        proxy_pass http://api:8502;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_hide_header Cache-Control;
        proxy_hide_header Cloudflare-CDN-Cache-Control;

        add_header Cache-Control "public, max-age=180, stale-while-revalidate=60" always;
        add_header Cloudflare-CDN-Cache-Control "public, max-age=300, stale-while-revalidate=600" always;
        add_header Vary "Accept-Encoding" always;
    }

    # ── API: Data health (operational, short cache) ──────────────────
    location /api/data-health {
        proxy_pass http://api:8502;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_hide_header Cache-Control;
        add_header Cache-Control "public, max-age=60" always;
        add_header Cloudflare-CDN-Cache-Control "public, max-age=120" always;
    }

    # ── API: Fallback (not cached — research, auth, future user endpoints)
    location /api/ {
        proxy_pass http://api:8502;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Cloudflare-CDN-Cache-Control "no-store" always;
    }

    # Health check
    location /health {
        proxy_pass http://api:8502;
        add_header Cache-Control "no-cache" always;
    }

    # Everything else -> SvelteKit frontend
    location / {
        proxy_pass http://frontend:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
